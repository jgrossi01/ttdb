{% extends 'layouts/base.html' %}
{% block title %}Configuración - {% endblock title %}

{% load static %}

{% block content %}

  <div class="page-wrapper">
    <!-- Page header -->
    <div class="page-header d-print-none">
      <div class="container-xl">
        <div class="row g-2 align-items-center">
          <div class="col">
            <!-- Page pre-title -->
            <div class="page-pretitle">
              Configuración
            </div>
            <h2 class="page-title">
              Hardware
            </h2>
          </div>
          <!-- Page title actions -->
          
        </div>
      </div>
    </div>
    <!-- Page body -->
    <div class="page-body">
      <div class="container-xl">
        <div class="row row-cards">
          <div class="col-lg-12">
            
            
            <div class="card">
              <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <a href="#tabs-placas-pxi" class="nav-link active" data-bs-toggle="tab" aria-selected="true" role="tab">Placas PXI</a>
                  </li>
                  <li class="nav-item" role="presentation">
                    <a href="#tabs-adaptadores" class="nav-link" data-bs-toggle="tab" aria-selected="false" tabindex="-1" role="tab">Adaptadores</a>
                  </li>
                  <li class="nav-item" role="presentation">
                    <a href="#tabs-conexion" class="nav-link" data-bs-toggle="tab" aria-selected="false" tabindex="-1" role="tab">Conexión</a>
                  </li>
                </ul>
              </div>
              <div class="card-body">
                <div class="tab-content">
                  <div class="tab-pane active show" id="tabs-placas-pxi" role="tabpanel">
                    <div class="card-header ps-0 pe-2 pt-0">
                      <h3 class="card-title">Placas PXI</h3>
                      <div class="card-actions">
                        <a href="#" class="btn btn-primary" id="btn-add-placas-pxi">
                          <!-- Download SVG icon from http://tabler-icons.io/i/plus -->
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 5l0 14"></path><path d="M5 12l14 0"></path></svg>
                          Agregar
                        </a>
                      </div>
                    </div>
                  
                    <table id="table-placas-pxi" class="table table-bordered w-100">
                      <thead>
                        <tr>
                          <th>Nombre</th>
                          <th>Bus</th>
                          <th>Device</th>
                          <th style="width: 1%">Acciones</th>
                        </tr>
                      </thead>
                      <tbody>
                        <!-- Las filas serán cargadas dinámicamente con DataTables -->
                      </tbody>
                    </table>
                    
                  </div>
            

            
                  <div class="tab-pane" id="tabs-adaptadores" role="tabpanel">
                    <div class="card-header ps-0 pe-2 pt-0">
                      <h3 class="card-title">Adaptadores</h3>
                      <div class="card-actions">
                        <a href="{% url 'new_adapter_view' %}" class="btn btn-primary" id="btn-add-adaptadores">
                          <!-- Download SVG icon from http://tabler-icons.io/i/plus -->
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 5l0 14"></path><path d="M5 12l14 0"></path></svg>
                          Agregar
                        </a>
                      </div>
                    </div>

                    <table id="table-adaptadores" class="table table-bordered w-100">
                      <thead>
                        <tr>
                          <th>Nombre</th>
                          <th>Conectores a PXI</th>
                          <th>Conectores a test</th>
                          <th>Acciones</th>
                        </tr>
                      </thead>
                    </table>
                  </div>
            
                  <div class="tab-pane" id="tabs-conexion" role="tabpanel">
                    <div class="card-header ps-0 pe-2 pt-0">
                      <h3 class="card-title">Conexión</h3>
                    </div>
                    
                    <div class="my-3">
                      <label class="form-label">Dirección del bus (IP y puerto)</label>
                      <input type="text" id="input-ip-port" class="form-control" value="tcp://localhost:6003">
                    </div>
                    <div class="d-flex justify-content-end pt-2">
                      <a href="#" class="btn btn-success" id="btn-save-config">
                        <!-- Download SVG icon from http://tabler-icons.io/i/plus -->
                        <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-device-floppy"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2" /><path d="M12 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M14 4l0 4l-6 0l0 -4" /></svg>
                        Guardar
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Contenedor para toasts -->
            <div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055"></div>

        </div>
      </div>
    </div>
    {% include 'includes/footer.html' %}
  </div>

  {% block modal %}
  
  <!-- Modal agregar placa PXI -->
  <div class="modal modal-blur fade show" id="new-pxi" tabindex="-1" style="display: none;">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Agregar placa PXI</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-control" name="name" placeholder="Nombre de la placa PXI">
          </div>
          <div class="mb-3">
            <label class="form-label">Bus</label>
            <input type="text" class="form-control" name="bus" placeholder="Bus de conexion de red">
          </div>
          <div class="mb-3">
            <label class="form-label">Device</label>
            <input type="text" class="form-control" name="device" placeholder="Numero de slot donde esta la placa en el PXI">
          </div>
          <div id="alert-container" class="row col-12">
          </div>
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-link link-secondary btn-3" data-bs-dismiss="modal"> Cancelar </a>
          <a href="#" class="btn btn-primary btn-5 ms-auto">
            <!-- Download SVG icon from http://tabler.io/icons/icon/plus -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-2">
              <path d="M12 5l0 14"></path>
              <path d="M5 12l14 0"></path>
            </svg>
            Agregar
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmación de eliminación -->
  <div class="modal modal-blur fade" id="modal-confirm" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
      <div class="modal-content">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="modal-status bg-danger"></div>
        <div class="modal-body text-center py-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-danger icon-lg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M10.24 3.957l-8.422 14.06a1.989 1.989 0 0 0 1.7 2.983h16.845a1.989 1.989 0 0 0 1.7 -2.983l-8.423 -14.06a1.989 1.989 0 0 0 -3.4 0z" />
            <path d="M12 9v4" />
            <path d="M12 17h.01" />
          </svg>
          <h3>Eliminar</h3>
          <div class="text-muted">¿Está seguro que desea eliminar este registro?</div>
        </div>
        <div class="modal-footer">
          <div class="w-100">
            <div class="row">
              <div class="col"><a href="#" class="btn w-100" data-bs-dismiss="modal">Cancelar</a></div>
              <div class="col"><a href="#" id="confirmDeleteBtn" class="btn btn-danger w-100">Eliminar</a></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% endblock modal %}

{% endblock content %}

{% block extrajs %}

<script src="{% static 'js/jquery-3.7.0.min.js' %}"></script>
<script src="{% static 'js/dataTables.js' %}"></script>
<script src="{% static 'js/dataTables.bootstrap5.js' %}"></script>

<script src="{% static 'dist/libs/tom-select/dist/js/tom-select.base.min.js' %}?1684106062" defer></script>

<script>

  document.addEventListener("DOMContentLoaded", function () {

    // =======================
    // UTILS
    // =======================

    function showToast(msg, type = "info") {
      const toast = document.createElement("div");
      toast.className = `toast align-items-center text-white bg-${type} border-0 my-1`;
      toast.setAttribute("role", "alert");
      toast.setAttribute("aria-live", "assertive");
      toast.setAttribute("aria-atomic", "true");
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${msg}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>`;
      document.getElementById("toastContainer").appendChild(toast);
      new bootstrap.Toast(toast).show();
      toast.addEventListener("hidden.bs.toast", () => toast.remove());
    }

    function showInlineAlert(container, message, type = "info") {
      const icons = {
        info: `
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon alert-icon icon-2">
            <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0"></path>
            <path d="M12 9h.01"></path>
            <path d="M11 12h1v4h1"></path>
          </svg>`,
        warning: `
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon alert-icon icon-2">
            <path d="M12 9v4"></path>
            <path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z"></path>
            <path d="M12 16h.01"></path>
          </svg>`,
        danger: `
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon alert-icon icon-2">
            <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0"></path>
            <path d="M12 8v4"></path>
            <path d="M12 16h.01"></path>
          </svg>`,
        success: `
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon alert-icon icon-2">
            <path d="M5 12l5 5l10 -10"></path>
          </svg>`
      };

      const icon = icons[type] || icons.info;

      const html = `
        <div class="alert alert-important alert-${type} alert-dismissible" role="alert">
          <div class="alert-icon">${icon}</div>
          <div>${message}</div>
          <a class="btn-close" data-bs-dismiss="alert" aria-label="close"></a>
        </div>
      `;

      container.innerHTML = html;
    }

    function getCSRFToken() {
      let value = null;
      if (document.cookie) {
        document.cookie.split(";").forEach(cookie => {
          if (cookie.trim().startsWith("csrftoken=")) {
            value = cookie.trim().substring("csrftoken=".length);
          }
        });
      }
      return value;
    }

    // =======================
    // RELAY CARD TABLE (placas-pxi)
    // =======================
    const tablaPlacasPxi = $('#table-placas-pxi').DataTable({
      ajax: '/api/hardware/get-relaycards/',
      dataSrc: 'data',
      columns: [
        { data: 'name', className: 'editable' },
        { data: 'bus', className: 'editable' },
        { data: 'device', className: 'editable' },
        {
          data: null,
          orderable: false,
          searchable: false,
          title: "Acciones",
          className: "text-center",
          render: (data, type, row) => `
            <button class="btn btn-sm btn-danger btn-delete" title="Eliminar" data-id="${row.id}" data-model="relaycard">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
                <path d="M4 7h16"></path>
                <path d="M10 11v6"></path>
                <path d="M14 11v6"></path>
                <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"></path>
                <path d="M9 7V4h6v3"></path>
              </svg>
            </button>`
        }
      ],
      language: { url: '{% static "datatables/datatables_es-ES.json" %}' },
      paging: false,
      searching: false,
      info: false,
      ordering: false,
      stateSave: false
    });

    // =======================
    // ADAPTER TABLE (adapters)
    // =======================
    const tablaAdapters = $('#table-adaptadores').DataTable({
      ajax: '/api/hardware/get-adapters/',
      dataSrc: 'data',
      columns: [
        { data: 'name', className: 'editable', title: 'Nombre', className: "text-center align-middle", },
        {
          data: 'pxi_connectors',
          title: 'Conectores lado PXI',
          orderable: false,
          searchable: false,
          className: "text-center align-middle",
          render: function (data, type, row) {
              return type === 'display' ? data : data.replace(/<br>/g, ', ');
          }
        },
        {
          data: 'test_connectors',
          title: 'Conectores lado TEST',
          orderable: false,
          searchable: false,
          className: "text-center align-middle",
          render: function (data, type, row) {
              return type === 'display' ? data : data.replace(/<br>/g, ', ');
          }
        },
        {
          data: null,
          orderable: false,
          searchable: false,
          title: "Acciones",
          className: "text-center align-middle",
          render: (data, type, row) => `
            <button class="btn btn-sm btn-primary btn-cntEditConectors" title="Editar conectores" data-id="${row.id}" data-model="adapter">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9.785 6l8.215 8.215l-2.054 2.054a5.81 5.81 0 1 1 -8.215 -8.215l2.054 -2.054z" /><path d="M4 20l3.5 -3.5" /><path d="M15 4l-3.5 3.5" /><path d="M20 9l-3.5 3.5" /></svg>
            </button>
            <button class="btn btn-sm btn-primary btn-cntEditConections" title="Editar conexiones" data-id="${row.id}" data-model="adapter">
              <svg  xmlns="http://www.w3.org/2000/svg"  width="18"  height="18"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 12l5 5l-1.5 1.5a3.536 3.536 0 1 1 -5 -5l1.5 -1.5z" /><path d="M17 12l-5 -5l1.5 -1.5a3.536 3.536 0 1 1 5 5l-1.5 1.5z" /><path d="M3 21l2.5 -2.5" /><path d="M18.5 5.5l2.5 -2.5" /><path d="M10 11l-2 2" /><path d="M13 14l-2 2" /></svg>
            </button>
            <button class="btn btn-sm btn-danger btn-delete" title="Eliminar" data-id="${row.id}" data-model="adapter">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
                <path d="M4 7h16"></path>
                <path d="M10 11v6"></path>
                <path d="M14 11v6"></path>
                <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"></path>
                <path d="M9 7V4h6v3"></path>
              </svg>
            </button>`
        }
      ],
      language: { url: '{% static "datatables/datatables_es-ES.json" %}' },
      paging: false,
      searching: false,
      info: false,
      ordering: false,
      stateSave: false
    });


    // =======================
    // MODALS
    // =======================
    const pxiModal = new bootstrap.Modal(document.getElementById('new-pxi'));
    const confirmModal = new bootstrap.Modal(document.getElementById('modal-confirm'));

    document.getElementById('btn-add-placas-pxi').addEventListener('click', () => {
      document.querySelectorAll('#new-pxi input').forEach(input => input.value = '');
      pxiModal.show();
    });

    let deletePayload = null;
    document.querySelector("#modal-confirm").addEventListener("hidden.bs.modal", function () {
      deletePayload = null;
    });
    
    // =======================
    // Agregar PXI
    // =======================

    document.querySelector('#new-pxi .btn-primary').addEventListener('click', () => {
      const modal = document.getElementById('new-pxi');
      const name = modal.querySelector('input[name="name"]').value.trim();
      const bus = modal.querySelector('input[name="bus"]').value.trim();
      const device = modal.querySelector('input[name="device"]').value.trim();
      const alertContainer = modal.querySelector("#alert-container");
      alertContainer.innerHTML = '';

      if (!name || !bus || !device) {
        showInlineAlert(alertContainer, "Todos los campos son obligatorios.", "warning");
        return;
      }

      if (!/^\d+$/.test(bus) || !/^\d+$/.test(device)) {
        showInlineAlert(alertContainer, "Los campos 'Bus' y 'Device' deben ser números enteros.", "warning");
        return;
      }

      fetch('/api/hardware/create/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
          model: 'RelayCard',
          fields: { name, bus: parseInt(bus), device: parseInt(device) }
        })
      })
      .then(response => {
        if (!response.ok) return response.json().then(data => Promise.reject(data));
        return response.json();
      })
      .then(res => {
        showToast(res.message || 'Placa agregada correctamente.', 'success');
        pxiModal.hide();
        $('#table-placas-pxi').DataTable().ajax.reload();
      })
      .catch(err => {
        if (err && err.message) {
          showInlineAlert(alertContainer, err.message, "danger");
        } else {
          showInlineAlert(alertContainer, "Error al crear la placa", "danger");
        }
      });

    });

    // =======================
    // Editar adaptadores inline
    // =======================
 
    document.querySelector('#table-adaptadores tbody').addEventListener('click', function (e) {
      const cellElement = e.target.closest('td.editable');
      if (!cellElement) return;

      const rowElement = cellElement.closest('tr');
      const row = tablaAdapters.row(rowElement);
      const rowData = row.data();
      const cellIndex = Array.from(cellElement.parentNode.children).indexOf(cellElement);
      const column = tablaAdapters.column(cellIndex).dataSrc();
      const oldValue = rowData[column];

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'form-control form-control-sm';
      input.value = oldValue;
      cellElement.innerHTML = '';
      cellElement.appendChild(input);
      input.focus();

      const restoreCell = () => {
        row.data(rowData).draw();
      };

      input.addEventListener('blur', function () {
        const newValue = input.value.trim();

        if (!newValue) {
          showToast("El valor no puede estar vacío", "warning");
          restoreCell();
          return;
        }

        if (newValue === oldValue) {
          restoreCell();
          return;
        }

        // Validación de duplicado
        const allData = tablaAdapters.rows().data().toArray();
        const nameExists = allData.some(d => d.id !== rowData.id && String(d.name).trim().toLowerCase() === newValue.toLowerCase());
        if (nameExists) {
          showToast("Este adaptador ya tiene un conector con esa etiqueta.", "warning");
          restoreCell();
          return;
        }

        const payload = {
          id: rowData.id,
          model: "adapter",
          field: column,
          value: newValue
        };

        fetch('/api/hardware/save/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          body: JSON.stringify(payload)
        })
        .then(res => {
          if (!res.ok) throw new Error();
          rowData[column] = newValue;
          row.data(rowData).draw();
          showToast("Actualizado con éxito", "success");
        })
        .catch(() => {
          restoreCell();
          showToast("Error al actualizar", "danger");
        });
      });

      input.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') input.blur();
        if (event.key === 'Escape') restoreCell();
      });
    });


    // =======================
    // Editar placas PXI inline
    // =======================

    document.querySelector('#table-placas-pxi tbody').addEventListener('click', function (e) {
      const cellElement = e.target.closest('td.editable');
      if (!cellElement) return;

      const rowElement = cellElement.closest('tr');
      const row = tablaPlacasPxi.row(rowElement);
      const rowData = row.data();
      const cellIndex = Array.from(cellElement.parentNode.children).indexOf(cellElement);
      const column = tablaPlacasPxi.column(cellIndex).dataSrc();
      const oldValue = rowData[column];

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'form-control form-control-sm';
      input.value = oldValue;
      cellElement.innerHTML = '';
      cellElement.appendChild(input);
      input.focus();

      const restoreCell = () => {
        row.data(rowData).draw();
      };

      input.addEventListener('blur', function () {
        const newValue = input.value.trim();

        if (!newValue) {
          showToast("El valor no puede estar vacío", "warning");
          restoreCell();
          return;
        }

        if ((column === 'bus' || column === 'device') && !/^\d+$/.test(newValue)) {
          showToast(`El campo "${column}" debe ser un número entero`, "warning");
          restoreCell();
          return;
        }

        if (newValue === String(oldValue)) {
          restoreCell();
          return;
        }

        // Validación de duplicado solo para 'name'
        if (column === 'name') {
          const allData = tablaPlacasPxi.rows().data().toArray();
          const nameExists = allData.some(d => d.id !== rowData.id && String(d.name).trim().toLowerCase() === newValue.toLowerCase());
          if (nameExists) {
            showToast("Ya existe un registro con ese nombre", "warning");
            restoreCell();
            return;
          }
        }

        const payload = {
          id: rowData.id,
          model: "relaycard",
          field: column,
          value: (column === 'bus' || column === 'device') ? parseInt(newValue) : newValue
        };

        fetch('/api/hardware/save/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          body: JSON.stringify(payload)
        })
        .then(res => {
          if (!res.ok) throw new Error();
          rowData[column] = payload.value;
          row.data(rowData).draw();
          showToast("Actualizado con éxito", "success");
        })
        .catch(() => {
          restoreCell();
          showToast("Error al actualizar", "danger");
        });
      });

      input.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') input.blur();
        if (event.key === 'Escape') restoreCell();
      });
    });



    // =======================
    // Eliminar registros
    // =======================

    document.querySelectorAll('#table-adaptadores, #table-placas-pxi').forEach(table => {
      table.addEventListener('click', function (e) {
        if (e.target.closest('.btn-delete')) {
          const button = e.target.closest('.btn-delete');
          const rowElement = button.closest('tr');
          const tabla = $(table).DataTable();
          const row = tabla.row(rowElement);
          const data = row.data();

          deletePayload = {
            model: button.getAttribute("data-model"),
            id: data.id,
            row: row,
            tabla: tabla
          };

          confirmModal.show();
        }
      });
    });

    document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
      if (!deletePayload) return;

      fetch("/api/hardware/delete/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({
          model: deletePayload.model,
          id: deletePayload.id
        })
      })
        .then(response => {
          if (!response.ok) throw new Error("Error al eliminar");
          deletePayload.row.remove().draw();
          confirmModal.hide();
          showToast("Registro eliminado con éxito", "success");
        })
        .catch(() => {
          showToast("Error al eliminar el registro", "danger");
        })
        .finally(() => {
          deletePayload = null;
        });
    });


    // =======================
    // CONNECTION CONFIG
    // =======================

    fetch('/api/hardware/connection_config/')
      .then(response => response.json())
      .then(res => {
        if (res.ip_port) {
          document.getElementById('input-ip-port').value = res.ip_port;
        }
      });

    document.getElementById('btn-save-config').addEventListener('click', () => {
      const ip_port = document.getElementById('input-ip-port').value.trim();

      if (!ip_port) {
        showToast("El campo IP/puerto no puede estar vacío", "warning");
        return;
      }

      fetch('/api/hardware/save/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
          id: 1,
          model: 'ConnectionConfig',
          field: 'ip_port',
          value: ip_port
        })
      })
        .then(res => {
          if (!res.ok) throw new Error();
          showToast("Configuración actualizada", "success");
        })
        .catch(() => {
          showToast("Error al guardar la configuración", "danger");
        });
    });

    // =======================
    // REDIRECCIÓN CONECTORES
    // =======================

    document.addEventListener('click', (e) => {
      const button = e.target.closest('.btn-cntEditConectors');
      if (button) {
        const adapterId = button.getAttribute('data-id');
        if (adapterId) {
          window.location.href = `/hardware/adapter/${adapterId}/connectors`;
        }
      }
    });

    document.addEventListener('click', (e) => {
      const button = e.target.closest('.btn-cntEditConections');
      if (button) {
        const adapterId = button.getAttribute('data-id');
        if (adapterId) {
          window.location.href = `/hardware/adapter/${adapterId}/connections`;
        }
      }
    });


  



  });

</script>
{% endblock extrajs %}

{% block extrastyle %}
{% endblock extrastyle %}